---
import Admin from '../../../layouts/Admin.astro';
import { getSupabaseAdmin } from '../../../lib/env';

const supabaseAdmin = getSupabaseAdmin();

let clients: any[] = [];
let error = '';

{
  const { data, error: fetchError } = await supabaseAdmin
    .from('clients')
    .select('*')
    .order('created_at', { ascending: false });

  if (fetchError) {
    error = fetchError.message;
  } else {
    clients = data || [];
  }
}
---

<Admin title="Clients">
  {error && <p class="mb-4 bg-red-50 text-red-600 p-3 rounded">{error}</p>}

  <div class="flex justify-between items-center mb-8">
    <h1 class="text-2xl font-bold">Clients</h1>
    <a href="/admin/clients/new" class="px-4 py-2 bg-neutral-900 text-white rounded hover:opacity-90">
      New Client
    </a>
  </div>

  {clients.length > 0 ? (
    <div class="bg-white rounded border border-neutral-200 overflow-hidden">
      <table class="w-full">
        <thead class="bg-neutral-50 border-b border-neutral-200">
          <tr>
            <th class="text-left p-4 text-sm font-semibold">Name</th>
            <th class="text-left p-4 text-sm font-semibold">Email</th>
            <th class="text-left p-4 text-sm font-semibold">Company</th>
            <th class="text-left p-4 text-sm font-semibold">Status</th>
            <th class="text-right p-4 text-sm font-semibold">Actions</th>
          </tr>
        </thead>
        <tbody>
          {clients.map((client) => (
            <tr class="border-b border-neutral-100 last:border-b-0 hover:bg-neutral-50">
              <td class="p-4">
                <a href={`/admin/clients/${client.id}`} class="font-medium hover:underline">
                  {client.name}
                </a>
              </td>
              <td class="p-4 text-sm text-neutral-600">{client.email}</td>
              <td class="p-4 text-sm text-neutral-600">{client.company || 'â€”'}</td>
              <td class="p-4">
                <span class:list={[
                  'px-2 py-1 text-xs rounded',
                  client.status === 'active' ? 'bg-green-100 text-green-700' : 'bg-neutral-100 text-neutral-600'
                ]}>
                  {client.status}
                </span>
              </td>
              <td class="p-4 text-right">
                <a href={`/admin/clients/${client.id}`} class="text-sm text-neutral-600 hover:text-neutral-900">
                  View
                </a>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  ) : (
    <div class="bg-white rounded border border-neutral-200 p-12 text-center">
      <p class="text-neutral-500 mb-4">No clients yet</p>
      <a href="/admin/clients/new" class="text-neutral-900 hover:underline">
        Add your first client
      </a>
    </div>
  )}
</Admin>
