---
import Admin from '../../../layouts/Admin.astro';
import { getSupabaseAdmin } from '../../../lib/env';

const supabaseAdmin = getSupabaseAdmin();

const levelFilter = Astro.url.searchParams.get('level') || 'all';

let query = supabaseAdmin
  .from('error_logs')
  .select('*')
  .order('created_at', { ascending: false })
  .limit(100);

if (levelFilter !== 'all') {
  query = query.eq('level', levelFilter);
}

const { data: errors, error: fetchError } = await query;

function formatDate(dateString: string) {
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', {
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
  });
}

function levelColor(level: string) {
  switch (level) {
    case 'critical': return 'bg-red-100 text-red-700';
    case 'error': return 'bg-orange-100 text-orange-700';
    case 'warn': return 'bg-yellow-100 text-yellow-700';
    default: return 'bg-neutral-100 text-neutral-600';
  }
}
---

<Admin title="Errors">
  {fetchError && <p class="mb-4 bg-red-50 text-red-600 p-3 rounded">{fetchError.message}</p>}

  <div class="flex justify-between items-center mb-8">
    <div class="flex gap-4 items-center">
      <h1 class="text-2xl font-bold">Error Logs</h1>
      <div class="flex gap-2">
        {['all', 'critical', 'error', 'warn'].map((level) => (
          <a
            href={level === 'all' ? '/admin/errors' : `/admin/errors?level=${level}`}
            class:list={[
              'px-3 py-1 text-sm rounded',
              levelFilter === level ? 'bg-neutral-900 text-white' : 'bg-neutral-100 text-neutral-600'
            ]}
          >
            {level.charAt(0).toUpperCase() + level.slice(1)}
          </a>
        ))}
      </div>
    </div>
  </div>

  {(errors && errors.length > 0) ? (
    <div class="bg-white rounded border border-neutral-200 overflow-hidden">
      <table class="w-full">
        <thead class="bg-neutral-50 border-b border-neutral-200">
          <tr>
            <th class="text-left p-4 text-sm font-semibold w-28">Level</th>
            <th class="text-left p-4 text-sm font-semibold">Message</th>
            <th class="text-left p-4 text-sm font-semibold w-32">Path</th>
            <th class="text-left p-4 text-sm font-semibold w-40">Time</th>
          </tr>
        </thead>
        <tbody>
          {errors.map((err: any) => (
            <tr class="border-b border-neutral-100 last:border-b-0 hover:bg-neutral-50 group">
              <td class="p-4">
                <span class:list={['px-2 py-1 text-xs rounded', levelColor(err.level)]}>
                  {err.level}
                </span>
              </td>
              <td class="p-4">
                <div class="text-sm font-medium">{err.message}</div>
                {err.context && Object.keys(err.context).length > 0 && (
                  <details class="mt-1">
                    <summary class="text-xs text-neutral-400 cursor-pointer hover:text-neutral-600">
                      context
                    </summary>
                    <pre class="mt-1 text-xs text-neutral-500 bg-neutral-50 p-2 rounded overflow-x-auto max-w-lg">{JSON.stringify(err.context, null, 2)}</pre>
                  </details>
                )}
                {err.stack && (
                  <details class="mt-1">
                    <summary class="text-xs text-neutral-400 cursor-pointer hover:text-neutral-600">
                      stack trace
                    </summary>
                    <pre class="mt-1 text-xs text-neutral-500 bg-neutral-50 p-2 rounded overflow-x-auto max-w-lg whitespace-pre-wrap">{err.stack}</pre>
                  </details>
                )}
              </td>
              <td class="p-4 text-sm text-neutral-600">{err.path || 'â€”'}</td>
              <td class="p-4 text-sm text-neutral-600">{formatDate(err.created_at)}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  ) : (
    <div class="bg-white rounded border border-neutral-200 p-12 text-center">
      <p class="text-neutral-500">No errors found</p>
    </div>
  )}
</Admin>
