---
import Admin from '../../../layouts/Admin.astro';
import { getSupabaseAdmin, getEnv } from '../../../lib/env';

const env = getEnv();
const secretKey = env.SUPABASE_SECRET_KEY;
const keyPreview = secretKey
  ? `${secretKey.slice(0, 10)}...${secretKey.slice(-4)} (len=${secretKey.length})`
  : 'MISSING';
console.log(`[admin/portfolio] SUPABASE_SECRET_KEY: ${keyPreview}`);

const supabaseAdmin = getSupabaseAdmin();

let portfolioItems: any[] = [];
let error = '';
let rlsWarning = false;

const statusFilter = Astro.url.searchParams.get('status') || 'all';

{
  let query = supabaseAdmin
    .from('portfolio_items')
    .select('*')
    .order('sort_order', { ascending: true });

  if (statusFilter !== 'all') {
    query = query.eq('status', statusFilter);
  }

  const { data, error: fetchError } = await query;

  if (fetchError) {
    error = fetchError.message;
  } else {
    portfolioItems = data || [];
    // Detect if RLS is silently filtering: admin should see drafts
    const hasDrafts = portfolioItems.some((i: any) => i.status === 'draft');
    console.log(`[admin/portfolio] Query returned ${portfolioItems.length} items, hasDrafts=${hasDrafts}, filter=${statusFilter}`);
    if (statusFilter === 'all' && portfolioItems.length > 0 && !hasDrafts) {
      rlsWarning = true;
    }
  }
}
---

<Admin title="Portfolio">
  {error && <p class="mb-4 bg-red-50 text-red-600 p-3 rounded">{error}</p>}
  {rlsWarning && (
    <div class="mb-4 bg-amber-50 border border-amber-200 text-amber-800 p-3 rounded text-sm">
      <strong>Warning:</strong> No draft items found â€” the admin service key may not be configured correctly.
      Verify that <code>SUPABASE_SECRET_KEY</code> is set to your project's <em>service_role</em> or <em>secret</em> key in Cloudflare Pages secrets, not the publishable key.
    </div>
  )}

  <div class="flex justify-between items-center mb-8">
    <div class="flex gap-4 items-center">
      <h1 class="text-2xl font-bold">Portfolio</h1>
      <div class="flex gap-2">
        <a
          href="/admin/portfolio"
          class:list={[
            'px-3 py-1 text-sm rounded',
            statusFilter === 'all' ? 'bg-neutral-900 text-white' : 'bg-neutral-100 text-neutral-600'
          ]}
        >
          All
        </a>
        <a
          href="/admin/portfolio?status=draft"
          class:list={[
            'px-3 py-1 text-sm rounded',
            statusFilter === 'draft' ? 'bg-neutral-900 text-white' : 'bg-neutral-100 text-neutral-600'
          ]}
        >
          Draft
        </a>
        <a
          href="/admin/portfolio?status=published"
          class:list={[
            'px-3 py-1 text-sm rounded',
            statusFilter === 'published' ? 'bg-neutral-900 text-white' : 'bg-neutral-100 text-neutral-600'
          ]}
        >
          Published
        </a>
      </div>
    </div>
    <a href="/admin/portfolio/new" class="px-4 py-2 bg-neutral-900 text-white rounded hover:opacity-90">
      New Portfolio Item
    </a>
  </div>

  {portfolioItems.length > 0 ? (
    <div class="bg-white rounded border border-neutral-200 overflow-hidden">
      <table class="w-full">
        <thead class="bg-neutral-50 border-b border-neutral-200">
          <tr>
            <th class="text-left p-4 text-sm font-semibold">Preview</th>
            <th class="text-left p-4 text-sm font-semibold">Title</th>
            <th class="text-left p-4 text-sm font-semibold">Category</th>
            <th class="text-left p-4 text-sm font-semibold">Status</th>
            <th class="text-left p-4 text-sm font-semibold">Sort</th>
            <th class="text-right p-4 text-sm font-semibold">Actions</th>
          </tr>
        </thead>
        <tbody>
          {portfolioItems.map((item) => (
            <tr class="border-b border-neutral-100 last:border-b-0 hover:bg-neutral-50">
              <td class="p-4">
                {item.media_type === 'image' ? (
                  <img src={item.thumbnail_url || item.media_url} alt={item.title} class="w-20 h-20 object-cover rounded" />
                ) : (
                  <div class="w-20 h-20 bg-neutral-900 rounded flex items-center justify-center text-white text-xs">
                    VIDEO
                  </div>
                )}
              </td>
              <td class="p-4">
                <a href={`/admin/portfolio/${item.id}`} class="font-medium hover:underline">
                  {item.title}
                </a>
                {item.is_case_study && (
                  <span class="ml-2 px-1.5 py-0.5 text-[10px] bg-blue-100 text-blue-700 rounded uppercase tracking-wide">Case Study</span>
                )}
              </td>
              <td class="p-4 text-sm text-neutral-600 capitalize">{item.category}</td>
              <td class="p-4">
                <span class:list={[
                  'px-2 py-1 text-xs rounded',
                  item.status === 'published' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'
                ]}>
                  {item.status}
                </span>
              </td>
              <td class="p-4 text-sm text-neutral-600">{item.sort_order}</td>
              <td class="p-4 text-right">
                <a href={`/admin/portfolio/${item.id}`} class="text-sm text-neutral-600 hover:text-neutral-900">
                  Edit
                </a>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  ) : (
    <div class="bg-white rounded border border-neutral-200 p-12 text-center">
      <p class="text-neutral-500 mb-4">No portfolio items found</p>
      <a href="/admin/portfolio/new" class="text-neutral-900 hover:underline">
        Add your first item
      </a>
    </div>
  )}
</Admin>
