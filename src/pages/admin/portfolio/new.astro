---
import Admin from '../../../layouts/Admin.astro';
import FileUpload from '../../../components/FileUpload.astro';
import { supabaseAdmin } from '../../../lib/supabase';

let error = '';

if (Astro.request.method === 'POST' && supabaseAdmin) {
  const formData = await Astro.request.formData();

  const { error: insertError } = await supabaseAdmin
    .from('portfolio_items')
    .insert({
      title: formData.get('title'),
      description: formData.get('description') || null,
      category: formData.get('category'),
      media_url: formData.get('media_url'),
      media_type: formData.get('media_type'),
      thumbnail_url: formData.get('thumbnail_url') || null,
      external_url: formData.get('external_url') || null,
      display_size: formData.get('display_size'),
      sort_order: parseInt(formData.get('sort_order') as string) || 0,
      status: formData.get('status'),
    });

  if (insertError) {
    error = insertError.message;
  } else {
    return Astro.redirect('/admin/portfolio');
  }
}
---

<Admin title="New Portfolio Item">
  {error && <p class="mb-4 bg-red-50 text-red-600 p-3 rounded">{error}</p>}

  <div class="mb-8">
    <h1 class="text-2xl font-bold">New Portfolio Item</h1>
  </div>

  <form method="POST" class="bg-white rounded border border-neutral-200 p-6 max-w-2xl">
    <div class="space-y-6">
      <div>
        <label for="title" class="block text-sm font-semibold mb-2">Title *</label>
        <input
          type="text"
          id="title"
          name="title"
          required
          class="w-full px-3 py-2 border border-neutral-300 rounded focus:outline-none focus:ring-2 focus:ring-neutral-900"
        />
      </div>

      <div>
        <label for="description" class="block text-sm font-semibold mb-2">Description</label>
        <textarea
          id="description"
          name="description"
          rows="4"
          class="w-full px-3 py-2 border border-neutral-300 rounded focus:outline-none focus:ring-2 focus:ring-neutral-900"
        ></textarea>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label for="category" class="block text-sm font-semibold mb-2">Category *</label>
          <select
            id="category"
            name="category"
            required
            class="w-full px-3 py-2 border border-neutral-300 rounded focus:outline-none focus:ring-2 focus:ring-neutral-900"
          >
            <option value="motion">Motion</option>
            <option value="graphic">Graphic</option>
            <option value="web">Web</option>
            <option value="brand">Brand</option>
          </select>
        </div>

        <div>
          <label for="media_type" class="block text-sm font-semibold mb-2">Media Type *</label>
          <select
            id="media_type"
            name="media_type"
            required
            class="w-full px-3 py-2 border border-neutral-300 rounded focus:outline-none focus:ring-2 focus:ring-neutral-900"
          >
            <option value="image">Image</option>
            <option value="video">Video</option>
          </select>
        </div>
      </div>

      <FileUpload
        name="media_url"
        label="Media File *"
        accept="image/jpeg,image/png,image/webp,image/gif,video/mp4"
      />

      <FileUpload
        name="thumbnail_url"
        label="Thumbnail Image"
        accept="image/jpeg,image/png,image/webp,image/gif"
      />

      <div>
        <label for="external_url" class="block text-sm font-semibold mb-2">External URL</label>
        <input
          type="text"
          id="external_url"
          name="external_url"
          placeholder="https://..."
          class="w-full px-3 py-2 border border-neutral-300 rounded focus:outline-none focus:ring-2 focus:ring-neutral-900"
        />
        <p class="text-xs text-neutral-500 mt-1">For web projects, link to live site</p>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label for="display_size" class="block text-sm font-semibold mb-2">Display Size *</label>
          <select
            id="display_size"
            name="display_size"
            required
            class="w-full px-3 py-2 border border-neutral-300 rounded focus:outline-none focus:ring-2 focus:ring-neutral-900"
          >
            <option value="small">Small</option>
            <option value="medium" selected>Medium</option>
            <option value="large">Large</option>
          </select>
        </div>

        <div>
          <label for="sort_order" class="block text-sm font-semibold mb-2">Sort Order</label>
          <input
            type="number"
            id="sort_order"
            name="sort_order"
            value="0"
            class="w-full px-3 py-2 border border-neutral-300 rounded focus:outline-none focus:ring-2 focus:ring-neutral-900"
          />
        </div>
      </div>

      <div>
        <label for="status" class="block text-sm font-semibold mb-2">Status *</label>
        <select
          id="status"
          name="status"
          required
          class="w-full px-3 py-2 border border-neutral-300 rounded focus:outline-none focus:ring-2 focus:ring-neutral-900"
        >
          <option value="draft" selected>Draft</option>
          <option value="published">Published</option>
        </select>
      </div>
    </div>

    <div class="flex gap-4 mt-8">
      <a href="/admin/portfolio" class="px-4 py-2 text-neutral-600 hover:text-neutral-900">
        Cancel
      </a>
      <button type="submit" class="px-4 py-2 bg-neutral-900 text-white rounded hover:opacity-90">
        Create Portfolio Item
      </button>
    </div>
  </form>
</Admin>
