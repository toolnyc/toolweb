---
import Admin from '../../../layouts/Admin.astro';
import FileUpload from '../../../components/FileUpload.astro';
import { getSupabaseAdmin } from '../../../lib/env';

const supabaseAdmin = getSupabaseAdmin();

let error = '';

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();

  const { error: insertError } = await supabaseAdmin
    .from('portfolio_items')
    .insert({
      title: formData.get('title'),
      description: formData.get('description') || null,
      category: formData.get('category'),
      media_url: formData.get('media_url'),
      media_type: formData.get('media_type'),
      thumbnail_url: formData.get('thumbnail_url') || null,
      external_url: formData.get('external_url') || null,
      display_size: formData.get('display_size'),
      sort_order: parseInt(formData.get('sort_order') as string) || 0,
      status: formData.get('status'),
      is_case_study: formData.get('is_case_study') === 'on',
      slug: formData.get('slug') || null,
      problem: formData.get('problem') || null,
      solution: formData.get('solution') || null,
      impact: formData.get('impact') || null,
    });

  if (insertError) {
    error = insertError.message;
  } else {
    return Astro.redirect('/admin/portfolio');
  }
}
---

<Admin title="New Portfolio Item">
  {error && <p class="mb-4 bg-red-50 text-red-600 p-3 rounded">{error}</p>}

  <div class="mb-8">
    <h1 class="text-2xl font-bold">New Portfolio Item</h1>
  </div>

  <form method="POST" class="bg-white rounded border border-neutral-200 p-6 max-w-2xl">
    <div class="space-y-6">
      <div>
        <label for="title" class="block text-sm font-semibold mb-2">Title *</label>
        <input
          type="text"
          id="title"
          name="title"
          required
          class="w-full px-3 py-2 border border-neutral-300 rounded focus:outline-none focus:ring-2 focus:ring-neutral-900"
        />
      </div>

      <div>
        <label for="description" class="block text-sm font-semibold mb-2">Description</label>
        <textarea
          id="description"
          name="description"
          rows="4"
          class="w-full px-3 py-2 border border-neutral-300 rounded focus:outline-none focus:ring-2 focus:ring-neutral-900"
        ></textarea>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label for="category" class="block text-sm font-semibold mb-2">Category *</label>
          <select
            id="category"
            name="category"
            required
            class="w-full px-3 py-2 border border-neutral-300 rounded focus:outline-none focus:ring-2 focus:ring-neutral-900"
          >
            <option value="motion">Motion</option>
            <option value="graphic">Graphic</option>
            <option value="web">Web</option>
            <option value="brand">Brand</option>
          </select>
        </div>

        <div>
          <label for="media_type" class="block text-sm font-semibold mb-2">Media Type *</label>
          <select
            id="media_type"
            name="media_type"
            required
            class="w-full px-3 py-2 border border-neutral-300 rounded focus:outline-none focus:ring-2 focus:ring-neutral-900"
          >
            <option value="image">Image</option>
            <option value="video">Video</option>
          </select>
        </div>
      </div>

      <FileUpload
        name="media_url"
        label="Media File *"
        accept="image/jpeg,image/png,image/webp,image/gif,video/mp4"
      />

      <div>
        <FileUpload
          name="thumbnail_url"
          label="Thumbnail Image"
          accept="image/jpeg,image/png,image/webp,image/gif"
        />
        <p id="video-thumbnail-hint" class="text-xs text-amber-600 mt-1 hidden">Recommended: upload a poster image for video items</p>
      </div>

      <div>
        <label for="external_url" class="block text-sm font-semibold mb-2">External URL</label>
        <input
          type="text"
          id="external_url"
          name="external_url"
          placeholder="https://..."
          class="w-full px-3 py-2 border border-neutral-300 rounded focus:outline-none focus:ring-2 focus:ring-neutral-900"
        />
        <p class="text-xs text-neutral-500 mt-1">For web projects, link to live site</p>
      </div>

      <div class="border-t border-neutral-200 pt-6">
        <label class="flex items-center gap-2 cursor-pointer">
          <input
            type="checkbox"
            id="is_case_study"
            name="is_case_study"
            class="w-4 h-4"
          />
          <span class="text-sm font-semibold">Case Study</span>
        </label>
        <p class="text-xs text-neutral-500 mt-1">Enable to create a dedicated /work/[slug] page for this project.</p>
      </div>

      <div id="case-study-fields" class="hidden">
        <div class="space-y-6">
          <div>
            <label for="slug" class="block text-sm font-semibold mb-2">URL Slug</label>
            <div class="flex items-center gap-2">
              <span class="text-sm text-neutral-500">/work/</span>
              <input
                type="text"
                id="slug"
                name="slug"
                placeholder="project-name"
                class="flex-1 px-3 py-2 border border-neutral-300 rounded focus:outline-none focus:ring-2 focus:ring-neutral-900"
              />
            </div>
          </div>

          <div>
            <label for="problem" class="block text-sm font-semibold mb-2">Problem</label>
            <textarea
              id="problem"
              name="problem"
              rows="3"
              placeholder="2-3 sentences. What was wrong."
              class="w-full px-3 py-2 border border-neutral-300 rounded focus:outline-none focus:ring-2 focus:ring-neutral-900"
            ></textarea>
          </div>

          <div>
            <label for="solution" class="block text-sm font-semibold mb-2">Solution</label>
            <textarea
              id="solution"
              name="solution"
              rows="3"
              placeholder="2-3 sentences. What you did."
              class="w-full px-3 py-2 border border-neutral-300 rounded focus:outline-none focus:ring-2 focus:ring-neutral-900"
            ></textarea>
          </div>

          <div>
            <label for="impact" class="block text-sm font-semibold mb-2">Impact</label>
            <textarea
              id="impact"
              name="impact"
              rows="2"
              placeholder="1-3 lines. Metrics or a client quote."
              class="w-full px-3 py-2 border border-neutral-300 rounded focus:outline-none focus:ring-2 focus:ring-neutral-900"
            ></textarea>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label for="display_size" class="block text-sm font-semibold mb-2">Display Size *</label>
          <select
            id="display_size"
            name="display_size"
            required
            class="w-full px-3 py-2 border border-neutral-300 rounded focus:outline-none focus:ring-2 focus:ring-neutral-900"
          >
            <option value="small">Small</option>
            <option value="medium" selected>Medium</option>
            <option value="large">Large</option>
          </select>
        </div>

        <div>
          <label for="sort_order" class="block text-sm font-semibold mb-2">Sort Order</label>
          <input
            type="number"
            id="sort_order"
            name="sort_order"
            value="0"
            class="w-full px-3 py-2 border border-neutral-300 rounded focus:outline-none focus:ring-2 focus:ring-neutral-900"
          />
        </div>
      </div>

      <div>
        <label for="status" class="block text-sm font-semibold mb-2">Status *</label>
        <select
          id="status"
          name="status"
          required
          class="w-full px-3 py-2 border border-neutral-300 rounded focus:outline-none focus:ring-2 focus:ring-neutral-900"
        >
          <option value="draft" selected>Draft</option>
          <option value="published">Published</option>
        </select>
      </div>
    </div>

    <div class="flex gap-4 mt-8">
      <a href="/admin/portfolio" class="px-4 py-2 text-neutral-600 hover:text-neutral-900">
        Cancel
      </a>
      <button type="submit" class="admin-submit-btn px-4 py-2 bg-neutral-900 text-white rounded hover:opacity-90 disabled:opacity-50" data-default-text="Create Portfolio Item">
        Create Portfolio Item
      </button>
    </div>
  </form>
</Admin>

<script>
  document.querySelectorAll<HTMLFormElement>('form[method="POST"]').forEach(form => {
    form.addEventListener('submit', () => {
      const btn = form.querySelector<HTMLButtonElement>('.admin-submit-btn');
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'Saving...';
      }
    });
  });

  const caseStudyCheckbox = document.getElementById('is_case_study') as HTMLInputElement;
  const caseStudyFields = document.getElementById('case-study-fields');
  if (caseStudyCheckbox && caseStudyFields) {
    caseStudyCheckbox.addEventListener('change', () => {
      caseStudyFields.classList.toggle('hidden', !caseStudyCheckbox.checked);
    });
  }

  const mediaTypeEl = document.getElementById('media_type');
  const videoThumbnailHint = document.getElementById('video-thumbnail-hint');
  if (mediaTypeEl && videoThumbnailHint) {
    const mediaTypeSelect = mediaTypeEl as unknown as HTMLSelectElement;
    function updateHint() {
      videoThumbnailHint!.classList.toggle('hidden', mediaTypeSelect.value !== 'video');
    }
    mediaTypeSelect.addEventListener('change', updateHint);
    updateHint();
  }
</script>
