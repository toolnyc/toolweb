---
import Admin from '../../../layouts/Admin.astro';
import { getSupabaseAdmin } from '../../../lib/env';

const supabaseAdmin = getSupabaseAdmin();

let products: any[] = [];
let error = '';

{
  const { data, error: fetchError } = await supabaseAdmin
    .from('products')
    .select('*, product_variants(count)')
    .order('created_at', { ascending: false });

  if (fetchError) {
    error = fetchError.message;
  } else {
    products = (data || []).map(product => ({
      ...product,
      variant_count: product.product_variants?.[0]?.count || 0
    }));
  }
}

function formatPrice(price: number) {
  return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(price);
}
---

<Admin title="Shop">
  {error && <p class="mb-4 bg-red-50 text-red-600 p-3 rounded">{error}</p>}

  <div class="flex justify-between items-center mb-8">
    <h1 class="text-2xl font-bold">Products</h1>
    <a href="/admin/shop/new" class="px-4 py-2 bg-neutral-900 text-white rounded hover:opacity-90">
      New Product
    </a>
  </div>

  {products.length > 0 ? (
    <div class="bg-white rounded border border-neutral-200 overflow-hidden">
      <table class="w-full">
        <thead class="bg-neutral-50 border-b border-neutral-200">
          <tr>
            <th class="text-left p-4 text-sm font-semibold">Product</th>
            <th class="text-left p-4 text-sm font-semibold">Price</th>
            <th class="text-left p-4 text-sm font-semibold">Status</th>
            <th class="text-left p-4 text-sm font-semibold">Variants</th>
            <th class="text-right p-4 text-sm font-semibold">Actions</th>
          </tr>
        </thead>
        <tbody>
          {products.map((product) => (
            <tr class="border-b border-neutral-100 last:border-b-0 hover:bg-neutral-50">
              <td class="p-4">
                <a href={`/admin/shop/${product.id}`} class="font-medium hover:underline">
                  {product.name}
                </a>
              </td>
              <td class="p-4 text-sm text-neutral-600">{formatPrice(product.price)}</td>
              <td class="p-4">
                <span class:list={[
                  'px-2 py-1 text-xs rounded',
                  product.status === 'active' ? 'bg-green-100 text-green-700' :
                  product.status === 'upcoming' ? 'bg-blue-100 text-blue-700' :
                  product.status === 'sold_out' ? 'bg-red-100 text-red-700' :
                  'bg-yellow-100 text-yellow-700'
                ]}>
                  {product.status}
                </span>
              </td>
              <td class="p-4 text-sm text-neutral-600">{product.variant_count}</td>
              <td class="p-4 text-right">
                <a href={`/admin/shop/${product.id}`} class="text-sm text-neutral-600 hover:text-neutral-900">
                  Edit
                </a>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  ) : (
    <div class="bg-white rounded border border-neutral-200 p-12 text-center">
      <p class="text-neutral-500 mb-4">No products yet</p>
      <a href="/admin/shop/new" class="text-neutral-900 hover:underline">
        Add your first product
      </a>
    </div>
  )}
</Admin>
