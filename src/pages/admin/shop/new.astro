---
import Admin from '../../../layouts/Admin.astro';
import { supabaseAdmin } from '../../../lib/supabase';

let error = '';

if (Astro.request.method === 'POST' && supabaseAdmin) {
  const formData = await Astro.request.formData();

  const { error: insertError } = await supabaseAdmin
    .from('products')
    .insert({
      name: formData.get('name'),
      description: formData.get('description') || null,
      price: parseFloat(formData.get('price') as string),
      image_url: formData.get('image_url') || null,
      status: formData.get('status'),
      drop_date: formData.get('drop_date') || null,
      shipping_domestic: parseFloat(formData.get('shipping_domestic') as string) || 5,
      shipping_international: parseFloat(formData.get('shipping_international') as string) || 15,
    });

  if (insertError) {
    error = insertError.message;
  } else {
    return Astro.redirect('/admin/shop');
  }
}
---

<Admin title="New Product">
  {error && <p class="mb-4 bg-red-50 text-red-600 p-3 rounded">{error}</p>}

  <div class="mb-8">
    <h1 class="text-2xl font-bold">New Product</h1>
  </div>

  <form method="POST" class="bg-white rounded border border-neutral-200 p-6 max-w-2xl">
    <div class="space-y-6">
      <div>
        <label for="name" class="block text-sm font-semibold mb-2">Name *</label>
        <input
          type="text"
          id="name"
          name="name"
          required
          class="w-full px-3 py-2 border border-neutral-300 rounded focus:outline-none focus:ring-2 focus:ring-neutral-900"
        />
      </div>

      <div>
        <label for="description" class="block text-sm font-semibold mb-2">Description</label>
        <textarea
          id="description"
          name="description"
          rows="4"
          class="w-full px-3 py-2 border border-neutral-300 rounded focus:outline-none focus:ring-2 focus:ring-neutral-900"
        ></textarea>
      </div>

      <div>
        <label for="price" class="block text-sm font-semibold mb-2">Price *</label>
        <input
          type="number"
          id="price"
          name="price"
          step="0.01"
          required
          class="w-full px-3 py-2 border border-neutral-300 rounded focus:outline-none focus:ring-2 focus:ring-neutral-900"
        />
      </div>

      <div>
        <label for="image_url" class="block text-sm font-semibold mb-2">Image URL</label>
        <input
          type="text"
          id="image_url"
          name="image_url"
          placeholder="https://..."
          class="w-full px-3 py-2 border border-neutral-300 rounded focus:outline-none focus:ring-2 focus:ring-neutral-900"
        />
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label for="status" class="block text-sm font-semibold mb-2">Status *</label>
          <select
            id="status"
            name="status"
            required
            class="w-full px-3 py-2 border border-neutral-300 rounded focus:outline-none focus:ring-2 focus:ring-neutral-900"
          >
            <option value="draft" selected>Draft</option>
            <option value="upcoming">Upcoming</option>
            <option value="active">Active</option>
            <option value="sold_out">Sold Out</option>
          </select>
        </div>

        <div>
          <label for="drop_date" class="block text-sm font-semibold mb-2">Drop Date</label>
          <input
            type="datetime-local"
            id="drop_date"
            name="drop_date"
            class="w-full px-3 py-2 border border-neutral-300 rounded focus:outline-none focus:ring-2 focus:ring-neutral-900"
          />
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label for="shipping_domestic" class="block text-sm font-semibold mb-2">Domestic Shipping ($)</label>
          <input
            type="number"
            id="shipping_domestic"
            name="shipping_domestic"
            step="0.01"
            value="5"
            class="w-full px-3 py-2 border border-neutral-300 rounded focus:outline-none focus:ring-2 focus:ring-neutral-900"
          />
        </div>

        <div>
          <label for="shipping_international" class="block text-sm font-semibold mb-2">International Shipping ($)</label>
          <input
            type="number"
            id="shipping_international"
            name="shipping_international"
            step="0.01"
            value="15"
            class="w-full px-3 py-2 border border-neutral-300 rounded focus:outline-none focus:ring-2 focus:ring-neutral-900"
          />
        </div>
      </div>
    </div>

    <div class="flex gap-4 mt-8">
      <a href="/admin/shop" class="px-4 py-2 text-neutral-600 hover:text-neutral-900">
        Cancel
      </a>
      <button type="submit" class="px-4 py-2 bg-neutral-900 text-white rounded hover:opacity-90">
        Create Product
      </button>
    </div>
  </form>
</Admin>
