---
import Admin from '../../../layouts/Admin.astro';
import { getSupabaseAdmin } from '../../../lib/env';

const supabaseAdmin = getSupabaseAdmin();

let contentItems: any[] = [];
let error = '';
let success = '';

{
  const { data } = await supabaseAdmin
    .from('site_content')
    .select('*')
    .order('content_group', { ascending: true })
    .order('sort_order', { ascending: true });

  contentItems = data || [];
}

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const contentId = formData.get('content_id') as string;
  const title = (formData.get('title') as string)?.trim() || null;
  const content = (formData.get('content') as string)?.trim();

  if (!contentId) {
    error = 'Missing content ID';
  } else if (!content) {
    error = 'Content is required';
  } else {
    const { error: updateError } = await supabaseAdmin
      .from('site_content')
      .update({
        title,
        content,
        updated_at: new Date().toISOString(),
      })
      .eq('id', contentId);

    if (updateError) {
      error = updateError.message;
    } else {
      success = 'Content updated';
      const { data } = await supabaseAdmin
        .from('site_content')
        .select('*')
        .order('content_group', { ascending: true })
        .order('sort_order', { ascending: true });
      contentItems = data || [];
    }
  }
}

const groupedContent = contentItems.reduce((acc, item) => {
  const group = item.content_group || 'general';
  if (!acc[group]) acc[group] = [];
  acc[group].push(item);
  return acc;
}, {} as Record<string, any[]>);
---

<Admin title="Site Content">
  {error && <p class="mb-4 bg-red-50 text-red-600 p-3 rounded">{error}</p>}
  {success && <p class="mb-4 bg-green-50 text-green-700 p-3 rounded">{success}</p>}

  <div class="mb-8">
    <h1 class="text-2xl font-bold">Site Content</h1>
    <p class="text-neutral-600 mt-1">Edit text content displayed on the public site</p>
  </div>

  <div class="space-y-8">
    {(Object.entries(groupedContent) as [string, any[]][]).map(([group, items]) => (
      <div class="bg-white rounded border border-neutral-200 p-6">
        <h2 class="text-lg font-semibold mb-6 capitalize">{group}</h2>

        <div class="space-y-6">
          {items.map((item: any) => (
            <form method="POST" class="border-b border-neutral-100 pb-6 last:border-b-0 last:pb-0">
              <input type="hidden" name="content_id" value={item.id} />

              <div class="space-y-4">
                <div>
                  <label for={`title-${item.id}`} class="block text-sm font-semibold mb-2">
                    {item.content_key}
                  </label>
                  <input
                    type="text"
                    id={`title-${item.id}`}
                    name="title"
                    value={item.title || ''}
                    placeholder="Optional title"
                    class="w-full px-3 py-2 border border-neutral-300 rounded focus:outline-none focus:ring-2 focus:ring-neutral-900"
                  />
                </div>

                <div>
                  <label for={`content-${item.id}`} class="block text-sm font-semibold mb-2">
                    Content
                  </label>
                  <textarea
                    id={`content-${item.id}`}
                    name="content"
                    rows="4"
                    required
                    class="w-full px-3 py-2 border border-neutral-300 rounded focus:outline-none focus:ring-2 focus:ring-neutral-900"
                  >{item.content}</textarea>
                  <p class="text-xs text-neutral-500 mt-1">
                    Last updated: {new Date(item.updated_at).toLocaleDateString('en-US', {
                      month: 'short',
                      day: 'numeric',
                      year: 'numeric',
                      hour: 'numeric',
                      minute: '2-digit'
                    })}
                  </p>
                </div>

                <button type="submit" class="px-4 py-2 bg-neutral-900 text-white rounded hover:opacity-90 text-sm">
                  Save Changes
                </button>
              </div>
            </form>
          ))}
        </div>
      </div>
    ))}
  </div>

  {contentItems.length === 0 && (
    <div class="bg-white rounded border border-neutral-200 p-12 text-center">
      <p class="text-neutral-500">No site content configured</p>
    </div>
  )}
</Admin>
