---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import StickyBar from '../components/StickyBar.astro';
import Accordion from '../components/Accordion.astro';
import WritingBlock from '../components/WritingBlock.astro';
import VideoPlayer from '../components/VideoPlayer.astro';

import {
  getPublishedPortfolio,
  getPublishedWriting,
  getVisibleClientLogos,
  getVisibleTestimonials,
  getSiteContentByKey,
} from '../lib/queries';
import type { PortfolioItem } from '../lib/types';

// Fetch all data in parallel
const [portfolio, writing, clients, testimonials, heroTagline, aboutBlurb, processBlurb] = await Promise.all([
  getPublishedPortfolio(),
  getPublishedWriting(),
  getVisibleClientLogos(),
  getVisibleTestimonials(),
  getSiteContentByKey('hero_tagline'),
  getSiteContentByKey('about_blurb'),
  getSiteContentByKey('process_blurb'),
]);

// Map display_size to responsive column spans
const lgSpanMap: Record<string, number> = { small: 8, medium: 12, large: 16 };
const mdSpanMap: Record<string, number> = { small: 6, medium: 6, large: 12 };

// Chunk portfolio items for interleaving with writing snippets
const chunkSize = 4;
const portfolioChunks: PortfolioItem[][] = [];
for (let i = 0; i < portfolio.length; i += chunkSize) {
  portfolioChunks.push(portfolio.slice(i, i + chunkSize));
}
---

<BaseLayout>
  <Header />

  <main class="pb-12">
    {/* ── 1. Hero ─────────────────────────────────────────── */}
    <section class="min-h-[100svh] flex items-end site-grid pb-8">
      <div class="col-span-6 lg:col-span-24">
        <h1 class="text-hero font-bold uppercase tracking-tight anim-fade-up" data-anim="hero-title">TOOL</h1>
        <p class="text-body text-caption-gray mt-2 max-w-md anim-fade-up" data-anim="hero-subtitle">
          {heroTagline?.content ?? 'Brand, design, and web development.'}
        </p>
        <button data-cal-link="toolnyc/30min" data-cal-config='{"layout":"month_view"}' class="inline-block mt-4 text-body border border-neutral-900 px-4 py-2 hover:bg-neutral-900 hover:text-white transition-colors cursor-pointer bg-transparent anim-fade-up" data-anim="hero-cta">
          Let's talk
        </button>
      </div>
    </section>

    {/* ── 2. Portfolio grid with writing snippets ─────────── */}
    <section class="site-grid">
      {portfolioChunks.map((chunk, chunkIndex) => (
        <>
          {chunk.map((item) => {
            const lgSpan = lgSpanMap[item.display_size] ?? 8;
            const mdSpan = mdSpanMap[item.display_size] ?? 6;
            return (
              <div
                class="col-span-6 relative overflow-hidden anim-fade-up"
                style={`grid-column: span 6`}
                data-md-span={mdSpan}
                data-lg-span={lgSpan}
              >
                {item.media_type === 'video' ? (
                  <VideoPlayer src={item.media_url} poster={item.thumbnail_url ?? undefined} title={item.title} />
                ) : (
                  <img
                    src={item.media_url}
                    alt={item.title}
                    class="w-full h-auto block"
                  />
                )}

                {item.is_case_study && item.slug ? (
                  <a
                    href={`/work/${item.slug}`}
                    class="absolute inset-0 flex items-end p-2"
                  >
                    <span class="text-body text-caption-gray bg-white/90 px-1 py-[2px]">
                      View case study &rarr;
                    </span>
                  </a>
                ) : item.external_url && (
                  <a
                    href={item.external_url}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="absolute inset-0 flex items-end p-2"
                  >
                    <span class="text-body text-caption-gray bg-white/90 px-1 py-[2px]">
                      View project &rarr;
                    </span>
                  </a>
                )}
              </div>
            );
          })}

          {/* Writing snippet after this chunk */}
          {writing[chunkIndex] && (
            <WritingBlock snippet={writing[chunkIndex]} />
          )}
        </>
      ))}

      {/* Remaining writing snippets */}
      {writing.slice(portfolioChunks.length).map((snippet) => (
        <WritingBlock snippet={snippet} />
      ))}
    </section>

    {/* ── 3. Client list ──────────────────────────────────── */}
    {clients.length > 0 && (
      <section class="site-grid py-8 anim-fade" data-anim="clients">
        <div class="col-span-6 lg:col-span-24">
          <p class="text-body text-caption-gray">
            {clients.map((client, i) => (
              <>
                {i > 0 && <span> &middot; </span>}
                {client.website_url ? (
                  <a
                    href={client.website_url}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="hover:text-neutral-900 transition-colors"
                  >
                    {client.name}
                  </a>
                ) : (
                  <span>{client.name}</span>
                )}
              </>
            ))}
          </p>
        </div>
      </section>
    )}

    {/* ── 4. Testimonials ─────────────────────────────────── */}
    {testimonials.length > 0 && (
      <section class="site-grid py-8 anim-fade" data-anim="testimonials">
        <div class="col-span-6 lg:col-span-24 space-y-6">
          {testimonials.map((t) => (
            <blockquote class="max-w-2xl">
              <p class="text-body text-neutral-900">&ldquo;{t.quote}&rdquo;</p>
              <footer class="text-body text-caption-gray mt-1">
                {t.attribution}{t.company && <span> &mdash; {t.company}</span>}
              </footer>
            </blockquote>
          ))}
        </div>
      </section>
    )}

    {/* ── 5. Accordion sections ───────────────────────────── */}
    <section class="site-grid anim-fade" data-anim="accordion">
      <div class="col-span-6 lg:col-span-24 space-y-[1px]">
        <Accordion title="Services">
          <div class="space-y-6 py-2">
            <div>
              <h3 class="text-body font-medium mb-3">Brand</h3>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-body text-caption-gray">
                <div>
                  <p class="text-neutral-900 font-medium">Brand Sprint</p>
                  <p>Logo, color system, type system, brand guidelines. 2 weeks.</p>
                  <p class="text-neutral-900 mt-1">From $6,000</p>
                </div>
                <div>
                  <p class="text-neutral-900 font-medium">Full Identity</p>
                  <p>Everything in Sprint + strategy, voice/tone, social templates, collateral. 4 weeks.</p>
                  <p class="text-neutral-900 mt-1">From $12,000</p>
                </div>
                <div>
                  <p class="text-neutral-900 font-medium">Brand + Collateral</p>
                  <p>Everything in Full Identity + packaging, menus, environmental graphics, merch. 6 weeks.</p>
                  <p class="text-neutral-900 mt-1">From $18,000</p>
                </div>
              </div>
            </div>

            <div>
              <h3 class="text-body font-medium mb-3">Web</h3>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-body text-caption-gray">
                <div>
                  <p class="text-neutral-900 font-medium">Starter Site</p>
                  <p>3&ndash;5 pages, mobile-first, contact form, basic SEO. 3 weeks.</p>
                  <p class="text-neutral-900 mt-1">From $8,000</p>
                </div>
                <div>
                  <p class="text-neutral-900 font-medium">Business Site</p>
                  <p>5&ndash;10 pages, CMS, blog, analytics, 1 month post-launch support. 5 weeks.</p>
                  <p class="text-neutral-900 mt-1">From $14,000</p>
                </div>
                <div>
                  <p class="text-neutral-900 font-medium">Full Platform</p>
                  <p>Custom functionality &mdash; e-commerce, booking, portals, integrations. 6&ndash;10 weeks.</p>
                  <p class="text-neutral-900 mt-1">From $20,000</p>
                </div>
              </div>
            </div>

            <div>
              <h3 class="text-body font-medium mb-3">Brand + Web</h3>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-body text-caption-gray">
                <div>
                  <p class="text-neutral-900 font-medium">Launch Kit</p>
                  <p>Brand Sprint + Starter Site.</p>
                  <p class="text-neutral-900 mt-1">From $12,000</p>
                </div>
                <div>
                  <p class="text-neutral-900 font-medium">Growth Package</p>
                  <p>Full Identity + Business Site.</p>
                  <p class="text-neutral-900 mt-1">From $22,000</p>
                </div>
                <div>
                  <p class="text-neutral-900 font-medium">The Full Build</p>
                  <p>Brand + Collateral + Full Platform.</p>
                  <p class="text-neutral-900 mt-1">From $38,000</p>
                </div>
              </div>
            </div>

            <div>
              <h3 class="text-body font-medium mb-3">Retainers</h3>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-body text-caption-gray">
                <div>
                  <p class="text-neutral-900 font-medium">Maintenance</p>
                  <p>Hosting, updates, security, 2 hrs/month content changes.</p>
                  <p class="text-neutral-900 mt-1">$500/mo</p>
                </div>
                <div>
                  <p class="text-neutral-900 font-medium">Growth</p>
                  <p>Everything in Maintenance + 8 hrs/month design/dev, monthly analytics review.</p>
                  <p class="text-neutral-900 mt-1">$3,000/mo</p>
                </div>
                <div>
                  <p class="text-neutral-900 font-medium">Embedded</p>
                  <p>2 days/week dedicated, strategic partner, priority access.</p>
                  <p class="text-neutral-900 mt-1">$5,000/mo</p>
                </div>
              </div>
            </div>

            <p class="text-body text-caption-gray max-w-xl">
              Open-source stack. Your hosting, your data. No vendor lock-in.
            </p>
          </div>
        </Accordion>
        <Accordion title="Process">
          <p class="text-body text-caption-gray max-w-2xl">
            {processBlurb?.content ?? 'Discovery call. Scoped proposal. Design, build, launch. No handoffs between designers and developers; it\u2019s the same person. You own the code and the assets.'}
          </p>
        </Accordion>
        <Accordion title="About">
          <p class="text-body text-caption-gray max-w-2xl">
            {aboutBlurb?.content ?? 'Tool is a design and development practice based in New York. We build brands and websites on open-source tools \u2014 no vendor lock-in, no recurring platform fees. You own everything.'}
          </p>
        </Accordion>
      </div>
    </section>
  </main>

  <Footer />
  <StickyBar />
</BaseLayout>

<style is:global>
  /* Responsive column spans for portfolio items */
  @media (min-width: 800px) {
    [data-md-span="6"] { grid-column: span 6 !important; }
    [data-md-span="12"] { grid-column: span 12 !important; }
  }
  @media (min-width: 1000px) {
    [data-lg-span="8"] { grid-column: span 8 !important; }
    [data-lg-span="12"] { grid-column: span 12 !important; }
    [data-lg-span="16"] { grid-column: span 16 !important; }
  }
</style>
