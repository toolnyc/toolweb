---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import StickyBar from '../components/StickyBar.astro';
import Accordion from '../components/Accordion.astro';
import WritingBlock from '../components/WritingBlock.astro';
import VideoPlayer from '../components/VideoPlayer.astro';

import {
  getPublishedPortfolio,
  getPublishedWriting,
  getVisibleClientLogos,
  getVisibleTestimonials,
  getSiteContentByKey,
} from '../lib/queries';
import type { PortfolioItem } from '../lib/types';

// Fetch all data in parallel
const [portfolio, writing, clients, testimonials, heroTagline, aboutBlurb, processBlurb] = await Promise.all([
  getPublishedPortfolio(),
  getPublishedWriting(),
  getVisibleClientLogos(),
  getVisibleTestimonials(),
  getSiteContentByKey('hero_tagline'),
  getSiteContentByKey('about_blurb'),
  getSiteContentByKey('process_blurb'),
]);

// Map display_size to responsive column spans
const lgSpanMap: Record<string, number> = { small: 8, medium: 12, large: 16 };
const mdSpanMap: Record<string, number> = { small: 6, medium: 6, large: 12 };

// Deterministic aspect-ratio pattern based on item index for visual rhythm
const aspectPatterns = ['3/4', '16/9', '4/3', '1/1', '4/3', '16/9'] as const;
function getAspectRatio(index: number, displaySize: string): string {
  if (displaySize === 'large') {
    // Large items alternate between cinematic and square-ish
    return index % 2 === 0 ? '16/9' : '4/3';
  }
  return aspectPatterns[index % aspectPatterns.length];
}

// Chunk portfolio items for interleaving with writing snippets
const chunkSize = 4;
const portfolioChunks: PortfolioItem[][] = [];
for (let i = 0; i < portfolio.length; i += chunkSize) {
  portfolioChunks.push(portfolio.slice(i, i + chunkSize));
}
---

<BaseLayout>
  <Header />

  <main class="pb-14" id="main-content">
    {/* ── 1. Hero ─────────────────────────────────────────── */}
    <section class="min-h-[100svh] relative overflow-hidden flex flex-col items-center justify-center">
      <canvas id="eyes-canvas" class="absolute inset-0 w-full h-full pointer-events-none" data-anim="eyes-canvas"></canvas>
      <div class="relative z-10 text-center px-4 -mt-16">
        <p class="text-body text-caption-gray max-w-md mx-auto opacity-0" data-anim="hero-typing">
          <span class="hero-typing-text">{heroTagline?.content ?? 'Brand, design, and web development. New York.'}</span>
          <span class="hero-cursor" style="opacity: 0;" aria-hidden="true">|</span>
        </p>
      </div>

      {/* Client list — bottom-centered, just above sticky bar */}
      {clients.length > 0 && (
        <div class="absolute bottom-36 left-0 right-0 z-10 text-center px-4 anim-fade" data-anim="clients">
          <p class="text-body text-caption-gray">
            <span class="text-neutral-400">Trusted by:</span>
            {clients.map((client, i) => (
              <>
                <span> {i > 0 && <span>&middot;</span>} </span>
                {client.website_url ? (
                  <a
                    href={client.website_url}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="hover:text-neutral-900 transition-colors"
                  >
                    {client.name}
                  </a>
                ) : (
                  <span>{client.name}</span>
                )}
              </>
            ))}
          </p>
        </div>
      )}
    </section>

    {/* ── 3. Portfolio grid with writing snippets ─────────── */}
    <section class="site-grid">
      {portfolioChunks.map((chunk, chunkIndex) => {
        const baseIndex = chunkIndex * chunkSize;
        return (
        <>
          {chunk.map((item, i) => {
            const globalIndex = baseIndex + i;
            const lgSpan = lgSpanMap[item.display_size] ?? 8;
            const mdSpan = mdSpanMap[item.display_size] ?? 6;
            const aspect = getAspectRatio(globalIndex, item.display_size);
            return (
              <div
                class="portfolio-item col-span-6 relative overflow-hidden anim-fade-up"
                style={`grid-column: span 6; aspect-ratio: ${aspect}`}
                data-md-span={mdSpan}
                data-lg-span={lgSpan}
              >
                {item.media_type === 'video' ? (
                  <VideoPlayer src={item.media_url} poster={item.thumbnail_url ?? undefined} title={item.title} />
                ) : (
                  <img
                    src={item.media_url}
                    alt={item.title}
                    class="w-full h-full object-cover block"
                  />
                )}

                {item.is_case_study && item.slug ? (
                  <a
                    href={`/work/${item.slug}`}
                    class="portfolio-overlay absolute inset-0 flex items-end p-2"
                  >
                    <span class="text-body text-caption-gray bg-white/90 px-1 py-[2px]">
                      View case study &rarr;
                    </span>
                  </a>
                ) : item.external_url && (
                  <a
                    href={item.external_url}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="portfolio-overlay absolute inset-0 flex items-end p-2"
                  >
                    <span class="text-body text-caption-gray bg-white/90 px-1 py-[2px]">
                      View project &rarr;
                    </span>
                  </a>
                )}

                <div class="px-1 py-2">
                  <p class="text-[10px] uppercase tracking-widest text-[#00FFFF]">{item.category}</p>
                  <p class="text-sm font-medium text-white mt-1">{item.title}</p>
                  {item.description && (
                    <p class="text-xs text-neutral-400 mt-1 line-clamp-2">{item.description}</p>
                  )}
                </div>
              </div>
            );
          })}

          {/* Writing snippet after this chunk */}
          {writing[chunkIndex] && (
            <WritingBlock snippet={writing[chunkIndex]} />
          )}
        </>
        );
      })}

      {/* Remaining writing snippets */}
      {writing.slice(portfolioChunks.length).map((snippet) => (
        <WritingBlock snippet={snippet} />
      ))}
    </section>

    {/* ── 4. Testimonials ─────────────────────────────────── */}
    {testimonials.length > 0 && (
      <section class="site-grid py-8 anim-fade" data-anim="testimonials">
        <div class="col-span-6 lg:col-span-24 space-y-6">
          {testimonials.map((t) => (
            <blockquote class="max-w-2xl">
              <p class="text-body text-neutral-900">&ldquo;{t.quote}&rdquo;</p>
              <footer class="text-body text-caption-gray mt-1">
                {t.attribution}{t.company && <span> &mdash; {t.company}</span>}
              </footer>
            </blockquote>
          ))}
        </div>
      </section>
    )}

    {/* ── 5. Accordion sections ───────────────────────────── */}
    <section class="site-grid anim-fade" data-anim="accordion">
      <div class="col-span-6 lg:col-span-24 space-y-[1px]">
        <Accordion title="Services">
          <div class="space-y-8 py-2">
            <p class="text-body text-caption-gray max-w-xl">
              Open-source stack. Your hosting, your data. No vendor lock-in.
            </p>

            <div>
              <h3 class="text-snippet font-bold mb-4 tracking-tight">Brand</h3>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-[1px] bg-neutral-200">
                <a href="/book" class="service-card" data-hover="magenta">
                  <p class="text-neutral-900 font-semibold">Full Identity</p>
                  <p class="text-caption-gray mt-1">Logo, color system, type system, strategy, voice/tone, brand guidelines.</p>
                  <span class="service-tag">4 weeks</span>
                </a>
                <a href="/book" class="service-card" data-hover="magenta">
                  <p class="text-neutral-900 font-semibold">+ Collateral</p>
                  <p class="text-caption-gray mt-1">Everything in Full Identity + social templates, packaging, menus, environmental graphics, merch.</p>
                  <span class="service-tag">6 weeks</span>
                </a>
              </div>
            </div>

            <div>
              <h3 class="text-snippet font-bold mb-4 tracking-tight">Web</h3>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-[1px] bg-neutral-200">
                <a href="/book" class="service-card" data-hover="cyan">
                  <p class="text-neutral-900 font-semibold">Starter Site</p>
                  <p class="text-caption-gray mt-1">3&ndash;5 pages, mobile-first, contact form, basic SEO.</p>
                  <span class="service-tag">3 weeks</span>
                </a>
                <a href="/book" class="service-card" data-hover="cyan">
                  <p class="text-neutral-900 font-semibold">Business Site</p>
                  <p class="text-caption-gray mt-1">5&ndash;10 pages, CMS, blog, analytics, 1 month post-launch support.</p>
                  <span class="service-tag">5 weeks</span>
                </a>
                <a href="/book" class="service-card" data-hover="cyan">
                  <p class="text-neutral-900 font-semibold">Full Platform</p>
                  <p class="text-caption-gray mt-1">Custom functionality &mdash; e-commerce, booking, portals, integrations.</p>
                  <span class="service-tag">6&ndash;10 weeks</span>
                </a>
              </div>
            </div>

            <div>
              <h3 class="text-snippet font-bold mb-4 tracking-tight">Brand + Web</h3>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-[1px] bg-neutral-200">
                <a href="/book" class="service-card" data-hover="yellow">
                  <p class="text-neutral-900 font-semibold">Launch Kit</p>
                  <p class="text-caption-gray mt-1">Full Identity + Starter Site.</p>
                </a>
                <a href="/book" class="service-card" data-hover="yellow">
                  <p class="text-neutral-900 font-semibold">Growth Package</p>
                  <p class="text-caption-gray mt-1">+ Collateral + Business Site.</p>
                </a>
                <a href="/book" class="service-card" data-hover="yellow">
                  <p class="text-neutral-900 font-semibold">The Full Build</p>
                  <p class="text-caption-gray mt-1">+ Collateral + Full Platform.</p>
                </a>
              </div>
            </div>

            <div>
              <h3 class="text-snippet font-bold mb-4 tracking-tight">Retainers</h3>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-[1px] bg-neutral-200">
                <a href="/book" class="service-card" data-hover="magenta">
                  <p class="text-neutral-900 font-semibold">Maintenance</p>
                  <p class="text-caption-gray mt-1">Hosting, updates, security, small fixes.</p>
                </a>
                <a href="/book" class="service-card" data-hover="cyan">
                  <p class="text-neutral-900 font-semibold">On-Call</p>
                  <p class="text-caption-gray mt-1">Everything in Maintenance + priority design/dev hours.</p>
                </a>
                <a href="/book" class="service-card" data-hover="yellow">
                  <p class="text-neutral-900 font-semibold">Embedded</p>
                  <p class="text-caption-gray mt-1">Dedicated days, strategic partner, priority access.</p>
                </a>
              </div>
            </div>
          </div>
        </Accordion>
        <Accordion title="Process">
          <div class="space-y-8 py-2">
            <p class="text-body text-caption-gray max-w-xl">
              {processBlurb?.content ?? 'Five steps. No mystery. You know what\'s happening at every stage.'}
            </p>

            <div class="grid grid-cols-1 md:grid-cols-5 gap-[1px] bg-neutral-200">
              <a href="/book" class="process-card" data-step="1">
                <span class="text-caption-gray font-medium text-[11px] tracking-wider uppercase">01</span>
                <p class="text-neutral-900 font-semibold mt-2">Discovery</p>
                <p class="text-caption-gray mt-1">30-minute call. You talk about your business, goals, timeline. I ask questions. By the end we both know if it's a fit.</p>
              </a>
              <a href="/book" class="process-card" data-step="2">
                <span class="text-caption-gray font-medium text-[11px] tracking-wider uppercase">02</span>
                <p class="text-neutral-900 font-semibold mt-2">Proposal</p>
                <p class="text-caption-gray mt-1">Scoped document: what's included, timeline, cost. Fixed price. No surprises. You sign off or we adjust.</p>
              </a>
              <a href="/book" class="process-card" data-step="3">
                <span class="text-caption-gray font-medium text-[11px] tracking-wider uppercase">03</span>
                <p class="text-neutral-900 font-semibold mt-2">Design</p>
                <p class="text-caption-gray mt-1">Moodboards first, then high-fidelity mockups. Real designs in context, not wireframes. Revisions built in.</p>
              </a>
              <a href="/book" class="process-card" data-step="4">
                <span class="text-caption-gray font-medium text-[11px] tracking-wider uppercase">04</span>
                <p class="text-neutral-900 font-semibold mt-2">Build</p>
                <p class="text-caption-gray mt-1">Design and dev happen together &mdash; same person. No handoffs. You get a staging link and watch it come together.</p>
              </a>
              <a href="/book" class="process-card" data-step="5">
                <span class="text-caption-gray font-medium text-[11px] tracking-wider uppercase">05</span>
                <p class="text-neutral-900 font-semibold mt-2">Launch</p>
                <p class="text-caption-gray mt-1">Final review, DNS cutover, go live. I stick around for the first few weeks. You own the code, assets, hosting.</p>
              </a>
            </div>
          </div>
        </Accordion>
        <Accordion title="About">
          <p class="text-body text-caption-gray max-w-2xl">
            {aboutBlurb?.content ?? 'Tool is a design and development practice based in New York. We build brands and websites on open-source tools \u2014 no vendor lock-in, no recurring platform fees. You own everything.'}
          </p>
        </Accordion>
      </div>
    </section>
  </main>

  <Footer />
  <StickyBar />
</BaseLayout>

<style is:global>
  /* Responsive column spans for portfolio items */
  @media (min-width: 800px) {
    [data-md-span="6"] { grid-column: span 6 !important; }
    [data-md-span="12"] { grid-column: span 12 !important; }
  }
  @media (min-width: 1000px) {
    [data-lg-span="8"] { grid-column: span 8 !important; }
    [data-lg-span="12"] { grid-column: span 12 !important; }
    [data-lg-span="16"] { grid-column: span 16 !important; }
  }
</style>
