---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import StickyBar from '../components/StickyBar.astro';
import Accordion from '../components/Accordion.astro';
import WritingBlock from '../components/WritingBlock.astro';
import VideoPlayer from '../components/VideoPlayer.astro';

import {
  getPublishedPortfolio,
  getPublishedWriting,
  getVisibleClientLogos,
  getSiteContentByKey,
} from '../lib/queries';
import type { PortfolioItem } from '../lib/types';

// Fetch all data in parallel
const [portfolio, writing, clients, heroTagline, aboutBlurb, servicesBlurb, processBlurb] = await Promise.all([
  getPublishedPortfolio(),
  getPublishedWriting(),
  getVisibleClientLogos(),
  getSiteContentByKey('hero_tagline'),
  getSiteContentByKey('about_blurb'),
  getSiteContentByKey('services_blurb'),
  getSiteContentByKey('process_blurb'),
]);

// Map display_size to responsive column spans
const lgSpanMap: Record<string, number> = { small: 8, medium: 12, large: 16 };
const mdSpanMap: Record<string, number> = { small: 6, medium: 6, large: 12 };

// Chunk portfolio items for interleaving with writing snippets
const chunkSize = 4;
const portfolioChunks: PortfolioItem[][] = [];
for (let i = 0; i < portfolio.length; i += chunkSize) {
  portfolioChunks.push(portfolio.slice(i, i + chunkSize));
}
---

<BaseLayout>
  <Header />

  <main class="pb-12">
    {/* ── 1. Hero ─────────────────────────────────────────── */}
    <section class="min-h-[100svh] flex items-end site-grid pb-8">
      <div class="col-span-6 lg:col-span-24">
        <h1 class="text-hero font-bold uppercase tracking-tight anim-fade-up" data-anim="hero-title">TOOL</h1>
        <p class="text-body text-caption-gray mt-2 max-w-md anim-fade-up" data-anim="hero-subtitle">
          {heroTagline?.content ?? 'Full-service creative technical consultancy'}
        </p>
      </div>
    </section>

    {/* ── 2. Portfolio grid with writing snippets ─────────── */}
    <section class="site-grid">
      {portfolioChunks.map((chunk, chunkIndex) => (
        <>
          {chunk.map((item) => {
            const lgSpan = lgSpanMap[item.display_size] ?? 8;
            const mdSpan = mdSpanMap[item.display_size] ?? 6;
            return (
              <div
                class="col-span-6 relative overflow-hidden anim-fade-up"
                style={`grid-column: span 6`}
                data-md-span={mdSpan}
                data-lg-span={lgSpan}
              >
                {item.media_type === 'video' ? (
                  <VideoPlayer src={item.media_url} poster={item.thumbnail_url ?? undefined} title={item.title} />
                ) : (
                  <img
                    src={item.media_url}
                    alt={item.title}
                    class="w-full h-auto block"
                  />
                )}

                {item.external_url && (
                  <a
                    href={item.external_url}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="absolute inset-0 flex items-end p-2"
                  >
                    <span class="text-body text-caption-gray bg-white/90 px-1 py-[2px]">
                      View project &rarr;
                    </span>
                  </a>
                )}
              </div>
            );
          })}

          {/* Writing snippet after this chunk */}
          {writing[chunkIndex] && (
            <WritingBlock snippet={writing[chunkIndex]} />
          )}
        </>
      ))}

      {/* Remaining writing snippets */}
      {writing.slice(portfolioChunks.length).map((snippet) => (
        <WritingBlock snippet={snippet} />
      ))}
    </section>

    {/* ── 3. Client list ──────────────────────────────────── */}
    {clients.length > 0 && (
      <section class="site-grid py-8 anim-fade" data-anim="clients">
        <div class="col-span-6 lg:col-span-24">
          <p class="text-body text-caption-gray">
            {clients.map((client, i) => (
              <>
                {i > 0 && <span> &middot; </span>}
                {client.website_url ? (
                  <a
                    href={client.website_url}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="hover:text-neutral-900 transition-colors"
                  >
                    {client.name}
                  </a>
                ) : (
                  <span>{client.name}</span>
                )}
              </>
            ))}
          </p>
        </div>
      </section>
    )}

    {/* ── 4. Accordion sections ───────────────────────────── */}
    <section class="site-grid anim-fade" data-anim="accordion">
      <div class="col-span-6 lg:col-span-24 space-y-[1px]">
        <Accordion title="Services">
          <p class="text-body text-caption-gray max-w-2xl">
            {servicesBlurb?.content ?? 'Branding, graphic design, web design & development, motion graphics, video production, technical consulting, and creative direction.'}
          </p>
        </Accordion>
        <Accordion title="Process">
          <p class="text-body text-caption-gray max-w-2xl">
            {processBlurb?.content ?? 'We start with a discovery conversation to understand your goals, then move through research, concepting, design, build, and launch. Every project is different — we tailor the process to fit.'}
          </p>
        </Accordion>
        <Accordion title="About">
          <p class="text-body text-caption-gray max-w-2xl">
            {aboutBlurb?.content ?? 'Tool is a creative technical consultancy based in New York. We work with brands, startups, and cultural institutions on branding, design, and software development.'}
          </p>
        </Accordion>
      </div>
    </section>
  </main>

  <Footer />
  <StickyBar />
</BaseLayout>

<style is:global>
  /* Responsive column spans for portfolio items */
  @media (min-width: 800px) {
    [data-md-span="6"] { grid-column: span 6 !important; }
    [data-md-span="12"] { grid-column: span 12 !important; }
  }
  @media (min-width: 1000px) {
    [data-lg-span="8"] { grid-column: span 8 !important; }
    [data-lg-span="12"] { grid-column: span 12 !important; }
    [data-lg-span="16"] { grid-column: span 16 !important; }
  }
</style>
