---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import StickyBar from '../components/StickyBar.astro';
import Accordion from '../components/Accordion.astro';
import WritingBlock from '../components/WritingBlock.astro';
import VideoPlayer from '../components/VideoPlayer.astro';

import {
  getPublishedPortfolio,
  getPublishedWriting,
  getVisibleClientLogos,
  getVisibleTestimonials,
  getSiteContentByKey,
} from '../lib/queries';
import type { PortfolioItem } from '../lib/types';

// Fetch all data in parallel
const [portfolio, writing, clients, testimonials, heroTagline, aboutBlurb, processBlurb] = await Promise.all([
  getPublishedPortfolio(),
  getPublishedWriting(),
  getVisibleClientLogos(),
  getVisibleTestimonials(),
  getSiteContentByKey('hero_tagline'),
  getSiteContentByKey('about_blurb'),
  getSiteContentByKey('process_blurb'),
]);

// Map display_size to responsive column spans
const lgSpanMap: Record<string, number> = { small: 8, medium: 12, large: 16 };
const mdSpanMap: Record<string, number> = { small: 6, medium: 6, large: 12 };

// Chunk portfolio items for interleaving with writing snippets
const chunkSize = 4;
const portfolioChunks: PortfolioItem[][] = [];
for (let i = 0; i < portfolio.length; i += chunkSize) {
  portfolioChunks.push(portfolio.slice(i, i + chunkSize));
}
---

<BaseLayout>
  <Header />

  <main class="pb-14" id="main-content">
    {/* ── 1. Hero ─────────────────────────────────────────── */}
    <section class="min-h-[100svh] relative overflow-hidden flex items-center justify-center">
      <canvas id="dvd-canvas" class="absolute inset-0 w-full h-full pointer-events-none" data-anim="dvd-canvas"></canvas>
      <div class="relative z-10 text-center px-4">
        <p class="text-body text-caption-gray max-w-md mx-auto opacity-0 hero-tagline-backdrop" data-anim="hero-typing">
          <span class="hero-typing-text">{heroTagline?.content ?? 'Brand, design, and web development. New York.'}</span>
          <span class="hero-cursor" style="opacity: 0;" aria-hidden="true">|</span>
        </p>
      </div>
    </section>

    {/* ── 2. Portfolio grid with writing snippets ─────────── */}
    <section class="site-grid">
      {portfolioChunks.map((chunk, chunkIndex) => (
        <>
          {chunk.map((item) => {
            const lgSpan = lgSpanMap[item.display_size] ?? 8;
            const mdSpan = mdSpanMap[item.display_size] ?? 6;
            return (
              <div
                class="col-span-6 relative overflow-hidden anim-fade-up"
                style={`grid-column: span 6`}
                data-md-span={mdSpan}
                data-lg-span={lgSpan}
              >
                {item.media_type === 'video' ? (
                  <VideoPlayer src={item.media_url} poster={item.thumbnail_url ?? undefined} title={item.title} />
                ) : (
                  <img
                    src={item.media_url}
                    alt={item.title}
                    class="w-full h-auto block"
                  />
                )}

                {item.is_case_study && item.slug ? (
                  <a
                    href={`/work/${item.slug}`}
                    class="absolute inset-0 flex items-end p-2"
                  >
                    <span class="text-body text-caption-gray bg-white/90 px-1 py-[2px]">
                      View case study &rarr;
                    </span>
                  </a>
                ) : item.external_url && (
                  <a
                    href={item.external_url}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="absolute inset-0 flex items-end p-2"
                  >
                    <span class="text-body text-caption-gray bg-white/90 px-1 py-[2px]">
                      View project &rarr;
                    </span>
                  </a>
                )}
              </div>
            );
          })}

          {/* Writing snippet after this chunk */}
          {writing[chunkIndex] && (
            <WritingBlock snippet={writing[chunkIndex]} />
          )}
        </>
      ))}

      {/* Remaining writing snippets */}
      {writing.slice(portfolioChunks.length).map((snippet) => (
        <WritingBlock snippet={snippet} />
      ))}
    </section>

    {/* ── 3. Client list ──────────────────────────────────── */}
    {clients.length > 0 && (
      <section class="bg-neutral-900 py-6 anim-fade" data-anim="clients">
        <div class="site-grid">
          <div class="col-span-6 lg:col-span-24">
            <p class="text-[11px] tracking-wider uppercase text-neutral-500 mb-3">Selected clients</p>
            <p class="text-body text-neutral-400">
              {clients.map((client, i) => (
                <>
                  {i > 0 && <span class="text-neutral-600"> &middot; </span>}
                  {client.website_url ? (
                    <a
                      href={client.website_url}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="hover:text-white transition-colors"
                    >
                      {client.name}
                    </a>
                  ) : (
                    <span>{client.name}</span>
                  )}
                </>
              ))}
            </p>
          </div>
        </div>
      </section>
    )}

    {/* ── 4. Testimonials ─────────────────────────────────── */}
    {testimonials.length > 0 && (
      <section class="site-grid py-8 anim-fade" data-anim="testimonials">
        <div class="col-span-6 lg:col-span-24 space-y-6">
          {testimonials.map((t) => (
            <blockquote class="max-w-2xl">
              <p class="text-body text-neutral-900">&ldquo;{t.quote}&rdquo;</p>
              <footer class="text-body text-caption-gray mt-1">
                {t.attribution}{t.company && <span> &mdash; {t.company}</span>}
              </footer>
            </blockquote>
          ))}
        </div>
      </section>
    )}

    {/* ── 5. Accordion sections ───────────────────────────── */}
    <section class="site-grid anim-fade" data-anim="accordion">
      <div class="col-span-6 lg:col-span-24 space-y-[1px]">
        <Accordion title="Services">
          <div class="space-y-8 py-2">
            <p class="text-body text-caption-gray max-w-xl">
              Open-source stack. Your hosting, your data. No vendor lock-in.
            </p>

            <div>
              <h3 class="text-snippet font-bold mb-4 tracking-tight">Brand</h3>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-[1px] bg-neutral-200">
                <a href="/book" class="service-card" data-hover="magenta">
                  <p class="text-neutral-900 font-semibold">Full Identity</p>
                  <p class="text-caption-gray mt-1">Logo, color system, type system, strategy, voice/tone, brand guidelines. 4 weeks.</p>
                  <p class="text-neutral-900 font-medium mt-2">From $10,000</p>
                </a>
                <a href="/book" class="service-card" data-hover="magenta">
                  <p class="text-neutral-900 font-semibold">+ Collateral</p>
                  <p class="text-caption-gray mt-1">Everything in Full Identity + social templates, packaging, menus, environmental graphics, merch. 6 weeks.</p>
                  <p class="text-neutral-900 font-medium mt-2">From $12,000</p>
                </a>
              </div>
            </div>

            <div>
              <h3 class="text-snippet font-bold mb-4 tracking-tight">Web</h3>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-[1px] bg-neutral-200">
                <a href="/book" class="service-card" data-hover="cyan">
                  <p class="text-neutral-900 font-semibold">Starter Site</p>
                  <p class="text-caption-gray mt-1">3&ndash;5 pages, mobile-first, contact form, basic SEO. 3 weeks.</p>
                  <p class="text-neutral-900 font-medium mt-2">From $3,000</p>
                </a>
                <a href="/book" class="service-card" data-hover="cyan">
                  <p class="text-neutral-900 font-semibold">Business Site</p>
                  <p class="text-caption-gray mt-1">5&ndash;10 pages, CMS, blog, analytics, 1 month post-launch support. 5 weeks.</p>
                  <p class="text-neutral-900 font-medium mt-2">From $10,000</p>
                </a>
                <a href="/book" class="service-card" data-hover="cyan">
                  <p class="text-neutral-900 font-semibold">Full Platform</p>
                  <p class="text-caption-gray mt-1">Custom functionality &mdash; e-commerce, booking, portals, integrations. 6&ndash;10 weeks.</p>
                  <p class="text-neutral-900 font-medium mt-2">From $15,000</p>
                </a>
              </div>
            </div>

            <div>
              <h3 class="text-snippet font-bold mb-4 tracking-tight">Brand + Web</h3>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-[1px] bg-neutral-200">
                <a href="/book" class="service-card" data-hover="yellow">
                  <p class="text-neutral-900 font-semibold">Launch Kit</p>
                  <p class="text-caption-gray mt-1">Full Identity + Starter Site.</p>
                  <p class="text-neutral-900 font-medium mt-2">From $12,000</p>
                </a>
                <a href="/book" class="service-card" data-hover="yellow">
                  <p class="text-neutral-900 font-semibold">Growth Package</p>
                  <p class="text-caption-gray mt-1">+ Collateral + Business Site.</p>
                  <p class="text-neutral-900 font-medium mt-2">From $20,000</p>
                </a>
                <a href="/book" class="service-card" data-hover="yellow">
                  <p class="text-neutral-900 font-semibold">The Full Build</p>
                  <p class="text-caption-gray mt-1">+ Collateral + Full Platform.</p>
                  <p class="text-neutral-900 font-medium mt-2">From $25,000</p>
                </a>
              </div>
            </div>

            <div>
              <h3 class="text-snippet font-bold mb-4 tracking-tight">Retainers</h3>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-[1px] bg-neutral-200">
                <a href="/book" class="service-card" data-hover="magenta">
                  <p class="text-neutral-900 font-semibold">Maintenance</p>
                  <p class="text-caption-gray mt-1">Hosting, updates, security, small fixes. 2 hrs/month.</p>
                  <p class="text-neutral-900 font-medium mt-2">$500/mo</p>
                </a>
                <a href="/book" class="service-card" data-hover="cyan">
                  <p class="text-neutral-900 font-semibold">On-Call</p>
                  <p class="text-caption-gray mt-1">Everything in Maintenance + priority design/dev hours. 10 hrs/month.</p>
                  <p class="text-neutral-900 font-medium mt-2">$2,500/mo</p>
                </a>
                <a href="/book" class="service-card" data-hover="yellow">
                  <p class="text-neutral-900 font-semibold">Embedded</p>
                  <p class="text-caption-gray mt-1">Dedicated days, strategic partner, priority access. 2 days/week.</p>
                  <p class="text-neutral-900 font-medium mt-2">$5,000/mo</p>
                </a>
              </div>
            </div>
          </div>
        </Accordion>
        <Accordion title="Process">
          <div class="space-y-8 py-2">
            <p class="text-body text-caption-gray max-w-xl">
              {processBlurb?.content ?? 'Five steps. No mystery. You know what\'s happening at every stage.'}
            </p>

            <div class="grid grid-cols-1 md:grid-cols-5 gap-[1px] bg-neutral-200">
              <a href="/book" class="process-card" data-step="1">
                <span class="text-caption-gray font-medium text-[11px] tracking-wider uppercase">01</span>
                <p class="text-neutral-900 font-semibold mt-2">Discovery</p>
                <p class="text-caption-gray mt-1">30-minute call. You talk about your business, goals, timeline. I ask questions. By the end we both know if it's a fit.</p>
                <p class="text-caption-gray mt-2 text-[11px] tracking-wider uppercase">30 min</p>
              </a>
              <a href="/book" class="process-card" data-step="2">
                <span class="text-caption-gray font-medium text-[11px] tracking-wider uppercase">02</span>
                <p class="text-neutral-900 font-semibold mt-2">Proposal</p>
                <p class="text-caption-gray mt-1">Scoped document: what's included, timeline, cost. Fixed price. No surprises. You sign off or we adjust.</p>
                <p class="text-caption-gray mt-2 text-[11px] tracking-wider uppercase">2&ndash;3 days</p>
              </a>
              <a href="/book" class="process-card" data-step="3">
                <span class="text-caption-gray font-medium text-[11px] tracking-wider uppercase">03</span>
                <p class="text-neutral-900 font-semibold mt-2">Design</p>
                <p class="text-caption-gray mt-1">Moodboards first, then high-fidelity mockups. Real designs in context, not wireframes. Revisions built in.</p>
                <p class="text-caption-gray mt-2 text-[11px] tracking-wider uppercase">1&ndash;2 weeks</p>
              </a>
              <a href="/book" class="process-card" data-step="4">
                <span class="text-caption-gray font-medium text-[11px] tracking-wider uppercase">04</span>
                <p class="text-neutral-900 font-semibold mt-2">Build</p>
                <p class="text-caption-gray mt-1">Design and dev happen together &mdash; same person. No handoffs. You get a staging link and watch it come together.</p>
                <p class="text-caption-gray mt-2 text-[11px] tracking-wider uppercase">2&ndash;6 weeks</p>
              </a>
              <a href="/book" class="process-card" data-step="5">
                <span class="text-caption-gray font-medium text-[11px] tracking-wider uppercase">05</span>
                <p class="text-neutral-900 font-semibold mt-2">Launch</p>
                <p class="text-caption-gray mt-1">Final review, DNS cutover, go live. I stick around for the first few weeks. You own the code, assets, hosting.</p>
                <p class="text-caption-gray mt-2 text-[11px] tracking-wider uppercase">Day zero</p>
              </a>
            </div>
          </div>
        </Accordion>
        <Accordion title="About">
          <p class="text-body text-caption-gray max-w-2xl">
            {aboutBlurb?.content ?? 'Tool is a design and development practice based in New York. We build brands and websites on open-source tools \u2014 no vendor lock-in, no recurring platform fees. You own everything.'}
          </p>
        </Accordion>
      </div>
    </section>
  </main>

  <Footer />
  <StickyBar />
</BaseLayout>

<style is:global>
  /* Responsive column spans for portfolio items */
  @media (min-width: 800px) {
    [data-md-span="6"] { grid-column: span 6 !important; }
    [data-md-span="12"] { grid-column: span 12 !important; }
  }
  @media (min-width: 1000px) {
    [data-lg-span="8"] { grid-column: span 8 !important; }
    [data-lg-span="12"] { grid-column: span 12 !important; }
    [data-lg-span="16"] { grid-column: span 16 !important; }
  }
</style>
