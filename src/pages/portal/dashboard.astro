---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { supabaseAdmin } from '../../lib/supabase';
import type { Project } from '../../lib/types';

const client = Astro.locals.client;
if (!client) return Astro.redirect('/portal');

// Fetch projects for this client
let projects: Project[] = [];
if (supabaseAdmin) {
  const { data } = await supabaseAdmin
    .from('projects')
    .select('*')
    .eq('client_id', client.id)
    .order('created_at', { ascending: false });
  projects = (data ?? []) as Project[];
}

const activeProjects = projects.filter((p) => p.status !== 'complete');
const pastProjects = projects.filter((p) => p.status === 'complete');

const statusColors: Record<string, string> = {
  inquiry: 'bg-neutral-200 text-neutral-700',
  discovery: 'bg-blue-100 text-blue-700',
  proposal: 'bg-purple-100 text-purple-700',
  active: 'bg-yellow-100 text-yellow-800',
  review: 'bg-orange-100 text-orange-700',
  complete: 'bg-green-100 text-green-700',
};

const statusSteps = ['inquiry', 'discovery', 'proposal', 'active', 'review', 'complete'];
---

<BaseLayout title="Dashboard â€” Tool">
  <main class="mx-auto max-w-2xl px-4 py-12">
    <div class="mb-8 flex items-center justify-between">
      <div>
        <h1 class="text-lg font-semibold">Welcome, {client.name}</h1>
        {client.company && <p class="text-sm text-neutral-500">{client.company}</p>}
      </div>
      <form method="POST" action="/api/auth/logout">
        <button type="submit" class="text-sm text-neutral-400 hover:text-neutral-600">Log out</button>
      </form>
    </div>

    {activeProjects.length > 0 && (
      <section class="mb-10">
        <h2 class="mb-4 text-sm font-medium uppercase tracking-wider text-neutral-400">Active Projects</h2>
        <div class="flex flex-col gap-4">
          {activeProjects.map((project) => {
            const currentStep = statusSteps.indexOf(project.status);
            return (
              <div class="border border-neutral-200 p-4">
                <div class="flex items-start justify-between">
                  <h3 class="font-medium">{project.title}</h3>
                  <span class:list={['inline-block rounded px-2 py-0.5 text-xs font-medium capitalize', statusColors[project.status] || 'bg-neutral-100']}>
                    {project.status}
                  </span>
                </div>

                {/* Status progress */}
                <div class="mt-3 flex gap-1">
                  {statusSteps.map((_step, i) => (
                    <div
                      class:list={[
                        'h-1 flex-1 rounded-full',
                        i <= currentStep ? 'bg-neutral-900' : 'bg-neutral-200',
                      ]}
                    />
                  ))}
                </div>

                <div class="mt-3 flex flex-wrap gap-3 text-sm">
                  {project.deliverables_url && (
                    <a
                      href={project.deliverables_url}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="text-neutral-600 underline hover:text-neutral-900"
                    >
                      View deliverables
                    </a>
                  )}
                  {project.stripe_invoice_url && (
                    <a
                      href={project.stripe_invoice_url}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="text-neutral-600 underline hover:text-neutral-900"
                    >
                      View invoice
                    </a>
                  )}
                </div>
              </div>
            );
          })}
        </div>
      </section>
    )}

    {pastProjects.length > 0 && (
      <section class="mb-10">
        <h2 class="mb-4 text-sm font-medium uppercase tracking-wider text-neutral-400">Past Projects</h2>
        <div class="flex flex-col gap-3">
          {pastProjects.map((project) => (
            <div class="flex items-center justify-between border border-neutral-100 px-4 py-3">
              <span class="font-medium">{project.title}</span>
              <div class="flex gap-3 text-sm">
                {project.deliverables_url && (
                  <a href={project.deliverables_url} target="_blank" rel="noopener noreferrer" class="text-neutral-500 underline hover:text-neutral-700">
                    Deliverables
                  </a>
                )}
              </div>
            </div>
          ))}
        </div>
      </section>
    )}

    {projects.length === 0 && (
      <p class="text-sm text-neutral-400">No projects yet.</p>
    )}
  </main>
</BaseLayout>
