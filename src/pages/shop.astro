---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import StickyBar from '../components/StickyBar.astro';
import '../styles/global.css';
import { getActiveProducts } from '../lib/queries';

const products = await getActiveProducts();
const activeProducts = products.filter(p => p.status === 'active');
const upcomingProducts = products.filter(p => p.status === 'upcoming');

function formatPrice(price: number) {
  return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(price);
}
---

<BaseLayout title="Shop â€” Tool">
  <Header />
  <main class="pb-14 pt-20">
    <h1 class="text-3xl font-bold text-center mb-12 mt-8">Shop</h1>

    {activeProducts.length === 0 && upcomingProducts.length === 0 && (
      <p class="text-neutral-400 text-center py-24">
        Nothing here right now. Check back sometime.
      </p>
    )}

    {activeProducts.length > 0 && (
      <div class="content-grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3">
        {activeProducts.map((product) => (
          <a href={`/shop/${product.id}`} class="block bg-white">
            {product.image_url ? (
              <img
                src={product.image_url}
                alt={product.name}
                class="aspect-square object-cover w-full bg-white"
              />
            ) : (
              <div class="aspect-square w-full bg-neutral-100" />
            )}
            <div class="p-4">
              <p class="font-medium">{product.name}</p>
              <p class="text-neutral-500 text-sm">{formatPrice(product.price)}</p>
            </div>
          </a>
        ))}
      </div>
    )}

    {upcomingProducts.length > 0 && (
      <div class:list={[
        'content-grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3',
        activeProducts.length > 0 && 'mt-16',
      ]}>
        {upcomingProducts.map((product) => (
          <a href={`/shop/${product.id}`} class="block bg-white">
            {product.image_url ? (
              <img
                src={product.image_url}
                alt={product.name}
                class="aspect-square object-cover w-full bg-white"
              />
            ) : (
              <div class="aspect-square w-full bg-neutral-100" />
            )}
            <div class="p-4">
              <p class="font-medium">{product.name}</p>
              <p class="text-neutral-500 text-sm">{formatPrice(product.price)}</p>
              {product.drop_date && (
                <span
                  class="text-xs text-neutral-400 mt-1 block"
                  data-drop-date={product.drop_date}
                >
                  Drops {new Date(product.drop_date).toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                  })}
                </span>
              )}
            </div>
          </a>
        ))}
      </div>
    )}
  </main>
  <StickyBar />
  <Footer />
</BaseLayout>

<script>
  function updateCountdowns() {
    document.querySelectorAll('[data-drop-date]').forEach(el => {
      const dropDate = new Date(el.getAttribute('data-drop-date')!);
      const now = new Date();
      const diff = dropDate.getTime() - now.getTime();
      if (diff <= 0) {
        el.textContent = 'Available now';
        return;
      }
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      if (days > 0) {
        el.textContent = `Drops in ${days}d ${hours}h`;
      } else {
        el.textContent = `Drops in ${hours}h ${mins}m`;
      }
    });
  }
  updateCountdowns();
  setInterval(updateCountdowns, 60000);
</script>
