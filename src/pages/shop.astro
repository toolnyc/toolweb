---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import StickyBar from '../components/StickyBar.astro';
import CountdownTimer from '../components/CountdownTimer.astro';
import { getActiveProducts } from '../lib/queries';

const products = await getActiveProducts();
const activeProducts = products.filter(p => p.status === 'active');
const upcomingProducts = products.filter(p => p.status === 'upcoming');

function formatPrice(price: number) {
  return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(price);
}
---

<BaseLayout title="Shop â€” Tool">
  <Header />
  <main class="pb-12" id="main-content">
    <div class="site-grid py-6">
      <p class="col-span-6 md:col-span-8 text-body font-medium">Shop</p>
    </div>

    {activeProducts.length === 0 && upcomingProducts.length === 0 && (
      <div class="site-grid py-24">
        <p class="col-span-6 text-body text-caption-gray">Nothing here right now. Check back sometime.</p>
      </div>
    )}

    {activeProducts.length > 0 && (
      <div class="site-grid">
        {activeProducts.map((product) => (
          <a href={`/shop/${product.id}`} class="col-span-3 md:col-span-4 lg:col-span-8 block">
            {product.image_url ? (
              <img
                src={product.image_url}
                alt={product.name}
                class="aspect-square object-cover w-full bg-lite-gray"
              />
            ) : (
              <div class="aspect-square w-full bg-lite-gray" />
            )}
            <div class="py-2">
              <p class="text-body font-medium">{product.name}</p>
              <p class="text-body text-caption-gray">{formatPrice(product.price)}</p>
            </div>
          </a>
        ))}
      </div>
    )}

    {upcomingProducts.length > 0 && (
      <div class:list={['site-grid', activeProducts.length > 0 && 'mt-8']}>
        {activeProducts.length > 0 && (
          <p class="col-span-6 lg:col-span-24 text-body text-caption-gray mb-2">Upcoming</p>
        )}
        {upcomingProducts.map((product) => (
          <a href={`/shop/${product.id}`} class="col-span-3 md:col-span-4 lg:col-span-8 block">
            {product.image_url ? (
              <img
                src={product.image_url}
                alt={product.name}
                class="aspect-square object-cover w-full bg-lite-gray"
              />
            ) : (
              <div class="aspect-square w-full bg-lite-gray" />
            )}
            <div class="py-2">
              <p class="text-body font-medium">{product.name}</p>
              <p class="text-body text-caption-gray">{formatPrice(product.price)}</p>
              {product.drop_date && (
                <span class="text-body text-caption-gray block">
                  <CountdownTimer dropDate={product.drop_date} />
                </span>
              )}
            </div>
          </a>
        ))}
      </div>
    )}
  </main>
  <Footer />
  <StickyBar />
</BaseLayout>
