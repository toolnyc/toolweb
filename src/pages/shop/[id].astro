---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import StickyBar from '../../components/StickyBar.astro';
import Accordion from '../../components/Accordion.astro';
import { getProductById } from '../../lib/queries';

const { id } = Astro.params;
const product = await getProductById(id!);

if (!product) return Astro.redirect('/shop');

function formatPrice(price: number) {
  return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(price);
}

const hasStock = product.variants.some(v => v.stock_count > 0);
---

<BaseLayout title={`${product.name} â€” Tool`}>
  <Header />
  <main class="pb-12" id="main-content">
    <div class="site-grid py-2">
      <a href="/shop" class="col-span-6 text-body text-caption-gray hover:text-neutral-900 transition-colors">&larr; Back to shop</a>
    </div>

    <div class="site-grid">
      <!-- Product image -->
      <div class="col-span-6 lg:col-span-16">
        {product.image_url ? (
          <img
            src={product.image_url}
            alt={product.name}
            class="w-full aspect-square object-cover bg-lite-gray"
            loading="eager"
            decoding="async"
          />
        ) : (
          <div class="w-full aspect-square bg-lite-gray" />
        )}
      </div>

      <!-- Product info -->
      <div class="col-span-6 lg:col-span-8 mt-4 lg:mt-0">
        <p class="text-body font-medium">{product.name}</p>
        <p class="text-body text-caption-gray mt-1">{formatPrice(product.price)}</p>

        {product.description && (
          <p class="text-body text-caption-gray mt-3">{product.description}</p>
        )}

        {product.variants.length > 0 && (
          <div class="mt-4">
            <p class="text-body font-medium mb-2">Size</p>
            <div class="flex flex-wrap gap-1">
              {product.variants
                .sort((a, b) => a.sort_order - b.sort_order)
                .map((variant) => (
                  <button
                    type="button"
                    data-variant-id={variant.id}
                    data-stock={variant.stock_count}
                    disabled={variant.stock_count <= 0}
                    class:list={[
                      'filter-pill transition-colors',
                      variant.stock_count <= 0 && 'opacity-40 line-through cursor-not-allowed',
                    ]}
                  >
                    {variant.label}
                  </button>
                ))}
            </div>
          </div>
        )}

        <div class="mt-4">
          <label for="quantity" class="text-body font-medium block mb-1">Quantity</label>
          <input
            type="number"
            id="quantity"
            name="quantity"
            min="1"
            value="1"
            class="py-2 text-body border-b border-neutral-300 bg-transparent focus:outline-none focus:border-neutral-900 w-16 transition-colors"
          />
        </div>

        <button
          id="add-to-cart"
          type="button"
          data-product-id={product.id}
          data-product-name={product.name}
          data-price={product.price}
          data-image-url={product.image_url || ''}
          disabled={!hasStock}
          class:list={[
            'w-full py-3 text-body font-medium text-center mt-4 transition-colors',
            hasStock
              ? 'bg-black text-white hover:opacity-90 cursor-pointer'
              : 'bg-black text-white opacity-40 cursor-not-allowed',
          ]}
        >
          {hasStock ? 'Add to bag' : 'Sold out'}
        </button>

        <div class="mt-4">
          <Accordion title="Shipping">
            <p class="text-body text-caption-gray">Ships within 1 week</p>
            <p class="text-body text-caption-gray mt-1">{formatPrice(product.shipping_domestic)} domestic &middot; {formatPrice(product.shipping_international)} international</p>
          </Accordion>
        </div>
      </div>
    </div>
  </main>
  <Footer />
  <StickyBar />
</BaseLayout>

<script>
  // Variant selection
  const variantButtons = document.querySelectorAll('[data-variant-id]');
  const addToCartBtn = document.querySelector('#add-to-cart') as HTMLButtonElement;
  const quantityInput = document.querySelector('#quantity') as HTMLInputElement;
  let selectedVariantId: string | null = null;

  variantButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      if ((btn as HTMLButtonElement).disabled) return;
      variantButtons.forEach(b => {
        b.classList.remove('active', 'bg-neutral-900', 'text-white');
      });
      btn.classList.add('active');
      selectedVariantId = (btn as HTMLElement).dataset.variantId!;
    });
  });

  // Auto-select first in-stock variant
  const firstInStock = document.querySelector('[data-variant-id]:not([disabled])') as HTMLButtonElement | null;
  if (firstInStock) {
    firstInStock.click();
  }

  // Add to cart
  addToCartBtn?.addEventListener('click', async () => {
    if (!selectedVariantId) {
      alert('Please select a size');
      return;
    }
    const quantity = parseInt(quantityInput?.value || '1', 10);
    const { addToCart } = await import('../../lib/cart');
    addToCart({
      variantId: selectedVariantId,
      productId: addToCartBtn.dataset.productId!,
      productName: addToCartBtn.dataset.productName!,
      variantLabel: document.querySelector(`[data-variant-id="${selectedVariantId}"]`)?.textContent?.trim() || '',
      price: parseFloat(addToCartBtn.dataset.price!),
      imageUrl: addToCartBtn.dataset.imageUrl || null,
    }, quantity);
    // Update cart count in sticky bar if it exists
    const cartCount = document.querySelector('#cart-count');
    if (cartCount) {
      const { getCartCount } = await import('../../lib/cart');
      cartCount.textContent = getCartCount().toString();
    }
    addToCartBtn.textContent = 'Added!';
    setTimeout(() => { addToCartBtn.textContent = 'Add to bag'; }, 1500);
  });
</script>
